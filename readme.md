# Sensorberg – Mosquitto (MQTT over TLS + Client Authentication) via Ansible

This repository provisions a Mosquitto MQTT broker on an RL9 VM using an Ansible role.

It configures:

- MQTT over TLS (default port 8883)
- mTLS (client certificate authentication)
- Server and client certificates generated locally on the VM (demo/testing CA)
- Per-tenant (per-building) topic isolation using ACLs
- Prometheus-compatible Mosquitto exporter
- `firewalld` configuration to allow MQTT TLS port

---
## Architecture Overview

- Mosquitto Broker
    - Mosquitto (latest version from distro)
    - TLS-enabled listener on `8883`
    - Client certificates required (mTLS)
    - Certificate CN used as logical identity
    - ACLs enforce per-tenant isolation
- Exporter
    - Runs as a Podman container
    - Subscribes to `$SYS/broker/#`
    - Exposes Prometheus metrics on `9234`
    - Connects via local-only MQTT listener (`127.0.0.1:1883`)
---

# What the Role Does

1. Enables EPEL for EL9:
   - Rocky: installs `epel-release`
2. Installs Mosquitto + dependencies
3. Ensures persistence directory exists (`/var/lib/mosquitto`)
4. Generates a local demo CA, then issues:
   - server certificate (with SANs)
   - a test client certificate (`test-client`)
5. Renders `/etc/mosquitto/mosquitto.conf`
6. Opens `8883/tcp` in `firewalld`
7. Enables and starts `mosquitto` service

---

# Requirements

# On Local Machine (control machine)
- Ansible (core) installed
- SSH access to the target VM

## On target VM
- Rocky 9 VM
- `sudo` privileges for the SSH user
- Internet access to fetch EPEL and packages from repos

---

## Inventory

Example `inventory.ini`:

```ini
[mosquitto]
mqtt ansible_host=<VM_PUBLIC_IP> ansible_user=rocky ansible_ssh_private_key_file=/Userkey/path/file.pem
---
## Groups_vars list

Variables to set in group_vars/mosquitto.yml (buildings list)
Each entry in mosquitto_buildings represents a tenant / site / building
---
##Running the playbook

`ansible-playbook -i inventory.ini site.yml`

The playbook will:

    - Install Mosquitto

    - Generate a demo CA

    - Generate server certificate (with SANs)

    - Generate per-building client certificates (demo purpose)

    - Configure ACLs

    - Start Mosquitto

    - Deploy Prometheus exporter

----

## Deafult ports:

8883/tcp — MQTT over TLS (mTLS required)
1883 - Local-only MQTT (exporter)
9234 - Prometheus metrics
Make sure  SG allows inbound 8883/tcp and 9234

## TLS / Certificate Details

/etc/mosquitto/certs/

## Expected files:

ca.crt, ca.key – demo CA

server.crt, server.key – broker server cert
clients - berlin_hq.crt, berlin_hq.key etc
test-client.crt, test-client.key – test client cert for validation

**** Client certificates are generated by Ansible for demo purposes only.
In production, client certificates should be issued by a central PKI.******

## Hostname verification

The client verifies the hostname. The server cert is issued for the host (e.g. mqtt) and includes SANs.

If we connect to 127.0.0.1 we may see hostname verify errors unless SAN includes it.
The recommended testing approach is:

Connect using the hostname that matches the certificate (e.g. mqtt)

Or add an /etc/hosts entry on the VM for local testing
echo "127.0.0.1 mqtt" | sudo tee -a /etc/hosts

---

## Verification / Testing Runbook
1. Check service status
sudo systemctl status mosquitto --no-pager
sudo ss -lntp | grep 8883


2. Client certificate is required

mosquitto_pub -V mqttv5 -h <BROKER_IP> -p 8883 \
  --cafile /etc/mosquitto/certs/ca.crt \
  -t test/x -m "should fail"

Expected: TLS error (certificate required)

3. Allowed publish (own building)

mosquitto_pub -V mqttv5 -h <BROKER_IP> -p 8883 \
  --cafile /etc/mosquitto/certs/ca.crt \
  --cert /etc/mosquitto/certs/clients/berlin_hq.crt \
  --key  /etc/mosquitto/certs/clients/berlin_hq.key \
  -t buildings/berlin_hq/devices/lock_123/telemetry \
  -m "ok"

Expected: publish succeeds

4. Denied publish (other building)

mosquitto_pub -V mqttv5 -h <BROKER_IP> -p 8883 \
  --cafile /etc/mosquitto/certs/ca.crt \
  --cert /etc/mosquitto/certs/clients/berlin_hq.crt \
  --key  /etc/mosquitto/certs/clients/berlin_hq.key \
  -t buildings/munich_hq/devices/lock_123/telemetry \
  -m "should fail"

Expected: Not authorized (RC:135)  

5. Negative test: connect WITHOUT TLS (should fail)

mosquitto_sub -h 127.0.0.1 -p 8883 -t test/#

Expected:

fails

6. Negative test: TLS but WITHOUT client cert (should fail)
mosquitto_sub -h 127.0.0.1 -p 8883 \
  --cafile /etc/mosquitto/certs/ca.crt \
  -t test/#

Expected:

fails

7. Positive test: mTLS subscribe (should succeed)

Subscriber terminal::

mosquitto_sub -V mqttv5 -h 127.0.0.1 -p 8883 \
  --cafile /etc/mosquitto/certs/ca.crt \
  --cert  /etc/mosquitto/certs/test-client.crt \
  --key   /etc/mosquitto/certs/test-client.key \
  -t 'buildings/test-client/#' -d

Publisher terminal:

mosquitto_pub -V mqttv5 -h 127.0.0.1 -p 8883 \
  --cafile /etc/mosquitto/certs/ca.crt \
  --cert  /etc/mosquitto/certs/test-client.crt \
  --key   /etc/mosquitto/certs/test-client.key \
  -t 'buildings/test-client/devices/door/101/state' \
  -m "closed" -r -d

Expected:

subscriber prints something like:

closed

##should FAIL with “Not authorized”
mosquitto_pub -V mqttv5 -h 127.0.0.1 -p 8883 \
  --cafile /etc/mosquitto/certs/ca.crt \
  --cert  /etc/mosquitto/certs/test-client.crt \
  --key   /etc/mosquitto/certs/test-client.key \
  -t 'buildings/berlin_hq/devices/door/101/state' \
  -m "should fail" -q 1 -d

## Key Configuration

Main broker config file:

/etc/mosquitto/mosquitto.conf

TLS/mTLS is enabled by:

listener 8883

cafile, certfile, keyfile

require_certificate true

allow_anonymous false

## Authorization (ACLs)

Mosquitto is configured to use certificate identities as usernames (use_identity_as_username).
Topic-based ACLs can be applied to restrict devices to building or device-specific namespaces, e.g.
buildings/<building_id>/devices/<device_id>/#.

For demonstration purposes, I have included a simple ACl example

===========================================EXPORTER=======================================

## Exporter setup:
The exporter exposes Mosquitto $SYS/broker/* statistics in Prometheus format.
Mosquitto does not natively expose Prometheus metrics. Instead, it publishes internal statistics under $SYS/broker/*.
The exporter subscribes to these topics and converts them into Prometheus-compatible metrics
1. Exporter runs as a container (Podman)
2. Exporter connects over plain MQTT locally, while all external traffic uses MQTT over TLS (8883).
3. TLS listener enforces client authentication (mTLS).
4. Ensures the exporter can access the local Mosquitto listener without container networking complexity.

## Validation:

1. Check exporter service:

systemctl status mosquitto_exporter
2. Port listening:

 ss -lntp | grep 9234

3. Verify metrics endpoint:

curl http://127.0.0.1:9234/metrics

Sample metrics:

broker_messages_received
broker_messages_sent
broker_clients_connected
broker_bytes_received
broker_load_messages_received_1min

## -----Note--------
Metrics only appear after MQTT traffic flows.
We need to Publish test messages if the endpoint appears empty.

Ports to be allowed:

1. 1883
2. 9234

## Issues faced while testing

1.  “host name verification failed”

Cause: I connected using a hostname that does not match the certificate SAN/CN.

fix: connected using -h mqtt (or the actual hostname in cert) or by adding /etc/hosts entry for local mapping
openssl s_client -connect 127.0.0.1:8883 -CAfile /etc/mosquitto/certs/ca.crt </dev/null | tail -n 15
echo "127.0.0.1 mqtt" | sudo tee -a /etc/hosts

2. “tlsv1 alert unknown ca”

Cause: client CA file does not match the CA that signed server.crt.

fix: regenerated CA + server cert together again

3. Persistence errors (“unable to open mosquitto.db.new”)

Cause: /var/lib/mosquitto missing or wrong permissions.

fix: created the missing directories and set proper ownership(mosquitto) and permissions(750)

========================PromQL Query========================================

We expose Mosquitto $SYS metrics via mosquitto-exporter.
Since message counts are counters, we calculate hourly request volume using increase() rather than rate().

Hourly rate of MQTT requests (messages received):
sum(increase(broker_messages_received[1h]))

Per-second rate:
sum(rate(broker_messages_received[5m]))

Tested the result in server:

for i in {1..50}; do
  mosquitto_pub -h 127.0.0.1 -p 8883 \
    --cafile /etc/mosquitto/certs/ca.crt \
    --cert /etc/mosquitto/certs/test-client.crt \
    --key  /etc/mosquitto/certs/test-client.key \
    -t sensors/test \
    -m "msg-$i"
done

and immediatly checking the count using

curl -s http://127.0.0.1:9234/metrics | grep broker_messages_received

expected:(Example)

broker_messages_received 409

=======================================HA Improvements======================================

This assignment deploys a single Mosquitto instance. To improve resilience:

High Availability:

* We can run multiple Mosquitto nodes behind HAProxy/NGINX/cloud LB Or Keepalived (VIP)

* Use shared persistence (NFS) or stateless brokers

* Use bridging between brokers for message replication





